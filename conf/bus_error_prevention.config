/*
 * Configuration specifically designed to prevent bus errors
 * during PopPUNK model fitting stage
 * 
 * Use this config if you're experiencing bus errors during model fitting
 */

params {
    // Ultra-conservative PopPUNK parameters to prevent bus errors
    poppunk_stable = false           // Never use stable mode
    poppunk_reciprocal = false       // Disable reciprocal-only to reduce complexity
    poppunk_count_unique = false     // Disable unique distance counting
    poppunk_max_search = 5           // Minimal search depth
    poppunk_K = 2                    // Minimal mixture components
    poppunk_model_threads = 4        // Very conservative threading
    
    // Conservative resource allocation
    threads = 8                      // Reduced overall threading
    ram = '32 GB'                   // Conservative memory usage
    threads_per_chunk = 2           // Minimal chunk threading
    memory_per_chunk = '12 GB'      // Conservative chunk memory
}

process {
    // Ultra-conservative process settings
    errorStrategy = 'retry'
    maxRetries = 3
    
    withName: 'POPPUNK_MODEL' {
        cpus = 4                    // Minimal cores for model fitting
        memory = '32 GB'            // Conservative memory
        time = '12h'                // Extended time for slow processing
        errorStrategy = 'retry'
        maxRetries = 3
    }
    
    withName: 'POPPUNK_ASSIGN_CHUNK' {
        cpus = 2                    // Minimal chunk processing
        memory = '12 GB'
        time = '4h'
        maxForks = 2                // Limit parallel chunks
    }
    
    withName: 'MASH_SKETCH' {
        cpus = 8
        memory = '24 GB'
        time = '4h'
    }
    
    withName: 'MASH_DIST' {
        cpus = 6
        memory = '32 GB'
        time = '6h'
    }
}

// Detailed reporting for troubleshooting
report {
    enabled = true
    file = "${params.resultsDir}/reports/bus_error_prevention_report.html"
}

timeline {
    enabled = true
    file = "${params.resultsDir}/reports/bus_error_prevention_timeline.html"
}

dag {
    enabled = true
    file = "${params.resultsDir}/reports/bus_error_prevention_dag.svg"
}