/*
 * Configuration optimized for large datasets (3500+ samples)
 * Hardware: 22 cores, 64GB RAM
 * Fixes: Duplicate name conflicts and bus errors
 */

params {
    // Use chunked processing for large datasets
    use_all_samples = true  // Process all samples but in chunks
    
    // Optimized chunking parameters for 3500 samples
    threads_per_chunk = 4    // Conservative threading per chunk
    memory_per_chunk  = '16 GB'  // Memory per chunk
    
    // PopPUNK parameters optimized for stability and bus error prevention
    poppunk_stable = false   // Disable stable mode to prevent segfaults
    poppunk_max_zero_dist = 2  // Slightly more permissive for large datasets
    poppunk_max_merge = 5      // Allow more merges for better clustering
    poppunk_length_sigma = 3   // More lenient length filtering
    poppunk_K = 2            // Conservative mixture components for model fitting
    poppunk_max_search = 10  // Reduced search depth to prevent bus errors
}

process {
    // Global resource limits
    executor = 'local'
    errorStrategy = 'retry'
    maxRetries = 2
    
    // Specific process optimizations
    withName: 'POPPUNK_MODEL' {
        cpus = 8              // REDUCED: Conservative threading for model fitting
        memory = '48 GB'
        time = '8h'           // Increased time for conservative processing
        errorStrategy = 'retry'
        maxRetries = 2
    }
    
    withName: 'POPPUNK_ASSIGN_CHUNK' {
        cpus = 4
        memory = '16 GB'
        time = '2h'
        maxForks = 3  // Allow up to 3 chunks to run in parallel
    }
    
    withName: 'MASH_SKETCH' {
        cpus = 16
        memory = '32 GB'
        time = '2h'
    }
    
    withName: 'MASH_DIST' {
        cpus = 12
        memory = '40 GB'
        time = '4h'
    }
    
    withName: 'FILTER_ASSIGNMENT_SAMPLES' {
        cpus = 2
        memory = '8 GB'
        time = '30m'
    }
    
    withName: 'CHUNK_SAMPLES' {
        cpus = 2
        memory = '4 GB'
        time = '15m'
    }
    
    withName: 'MERGE_CHUNK_RESULTS' {
        cpus = 4
        memory = '16 GB'
        time = '30m'
    }
}

// Enable detailed reporting for troubleshooting
report {
    enabled = true
    file = "${params.resultsDir}/reports/execution_report.html"
}

timeline {
    enabled = true
    file = "${params.resultsDir}/reports/timeline.html"
}

dag {
    enabled = true
    file = "${params.resultsDir}/reports/pipeline_dag.svg"
}